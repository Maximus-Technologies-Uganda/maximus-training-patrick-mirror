name: CI/CD - Test then Deploy

on:
  push:
    branches: ["main"]
  pull_request:
    branches: ["main"]
  workflow_dispatch:

permissions:
  contents: 'read'
  id-token: 'write'
  pull-requests: 'write'

env:
  PROJECT_ID: 'proj-app-dev'
  REGION: 'africa-south1'

jobs:
  test-and-build:
    name: Quality Gate - Run All Checks
    runs-on: ubuntu-latest
    steps:
      - name: 'Checkout code'
        uses: 'actions/checkout@v4'

      - name: 'Set up Node.js with caching'
        uses: 'actions/setup-node@v4'
        with:
          node-version: '20'
          cache: 'npm' # <-- T061: Caches npm dependencies

      - name: 'Install All Dependencies'
        run: npm ci

      - name: 'Run Lint Check'
        id: lint
        run: npm run lint

      # TODO: Re-enable audit once jest-openapi vulnerability is resolved.
      # - name: 'Run Dependency Audit'
      #   run: npm audit --audit-level=high

      - name: 'Run All Tests (Unit & Contract)'
        id: tests
        run: npm test

      - name: 'Extract Test Coverage'
        id: coverage
        if: always() && steps.tests.outcome == 'success'
        run: |
          FILE=""
          if [ -f coverage/coverage-summary.json ]; then
            FILE="coverage/coverage-summary.json"
          elif [ -f api/coverage/coverage-summary.json ]; then
            FILE="api/coverage/coverage-summary.json"
          elif [ -f frontend-next/coverage/coverage-summary.json ]; then
            FILE="frontend-next/coverage/coverage-summary.json"
          fi
          if command -v jq >/dev/null 2>&1 && [ -n "$FILE" ]; then
            PCT=$(jq -r '.total.lines.pct // .total.statements.pct // empty' "$FILE")
            if [ -n "$PCT" ]; then
              echo "summary=${PCT}%" >> $GITHUB_OUTPUT
            else
              echo "summary=N/A" >> $GITHUB_OUTPUT
            fi
          else
            echo "summary=N/A" >> $GITHUB_OUTPUT
          fi

      - name: 'Build All Workspaces'
        id: build
        run: npm run build

      - name: 'Ensure frontend-next dependencies'
        run: npm ci --workspace=frontend-next

      - name: 'Cache Playwright browsers' # <-- T061: Caches Playwright binaries
        uses: 'actions/cache@v4'
        id: playwright-cache
        with:
          path: ~/.cache/ms-playwright
          key: ${{ runner.os }}-playwright-${{ hashFiles('**/package-lock.json') }}
          restore-keys: |
            ${{ runner.os }}-playwright-

      - name: 'Install Playwright Browsers'
        if: steps.playwright-cache.outputs.cache-hit != 'true'
        run: |
          npx --yes --package=@playwright/test -- playwright install --with-deps

      - name: 'Run Frontend A11y & E2E Tests'
        id: e2e
        run: npm run test:e2e -w frontend-next

      - name: 'Generate PR Summary Report'
        if: always()
        run: |
          echo "### ðŸ›¡ï¸ Quality Gate Summary" > pr-summary.md
          echo "" >> pr-summary.md
          echo "| Check | Result |" >> pr-summary.md
          echo "|---|---|" >> pr-summary.md
          echo "| **Lint** | ${{ steps.lint.outcome == 'success' && 'âœ… Passed' || 'âŒ Failed' }} |" >> pr-summary.md
          echo "| **Unit & Contract Tests** | ${{ steps.tests.outcome == 'success' && 'âœ… Passed' || 'âŒ Failed' }} |" >> pr-summary.md
          echo "| **Test Coverage** | \`${{ steps.coverage.outputs.summary || 'N/A' }}\` |" >> pr-summary.md
          echo "| **Production Build** | ${{ steps.build.outcome == 'success' && 'âœ… Passed' || 'âŒ Failed' }} |" >> pr-summary.md
          echo "| **E2E & A11y Tests** | ${{ steps.e2e.outcome == 'success' && 'âœ… Passed' || 'âŒ Failed' }} |" >> pr-summary.md
          echo "" >> pr-summary.md
          echo "**Overall Status: ${{ job.status == 'success' && 'âœ… All checks passed' || 'âŒ Some checks failed' }}**" >> pr-summary.md

      - name: 'Post PR Summary Comment'
        if: always() && github.event_name == 'pull_request'
        uses: 'marocchino/sticky-pull-request-comment@v2'
        with:
          path: pr-summary.md

      - name: 'Create Review Packet Manifest' # <-- T044: Creates the manifest file
        if: always()
        run: |
          echo '{' > manifest.json
          echo '  "commitSha": "${{ github.sha }}",' >> manifest.json
          echo '  "runId": "${{ github.run_id }}",' >> manifest.json
          echo '  "timestamp": "'$(date -u +'%Y-%m-%dT%H:%M:%SZ')'"' >> manifest.json
          echo '}' >> manifest.json

      - name: 'Upload Review Packet Artifact'
        if: always()
        uses: 'actions/upload-artifact@v4'
        with:
          name: review-packet
          path: |
            manifest.json # <-- T044: Includes the manifest in the artifact
            coverage/
            frontend-next/playwright-report/
          retention-days: 7

  deploy:
    name: Deploy to Cloud Run
    needs: test-and-build
    if: github.ref == 'refs/heads/main' && github.event_name == 'push'
    runs-on: ubuntu-latest
    steps:
      - name: 'Checkout code'
        uses: 'actions/checkout@v4'

      - name: 'Authenticate to Google Cloud'
        id: 'auth'
        uses: 'google-github-actions/auth@v2'
        with:
          workload_identity_provider: '${{ secrets.GCP_WORKLOAD_IDENTITY_PROVIDER }}'
          service_account: '${{ secrets.GCP_SERVICE_ACCOUNT_EMAIL }}'

      - name: 'Set up gcloud SDK'
        uses: 'google-github-actions/setup-gcloud@v2'

      - name: 'Submit monolithic build to Google Cloud Build'
        run: |
          gcloud builds submit \
            --config=cloudbuild.yaml \
            --project="${{ env.PROJECT_ID }}" \
            --region="${{ env.REGION }}" \
            .

