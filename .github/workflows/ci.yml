name: CI

on:
  pull_request:
  push:
    branches:
      - main

concurrency:
  group: ci-${{ github.ref }}
  cancel-in-progress: true

jobs:
  secret-scan: # T055 - Gitleaks (OSS CLI to avoid license issues)
    name: Security - Secret Scan (Gitleaks)
    runs-on: ubuntu-latest
    timeout-minutes: 5
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0 # Fetch all history for better leak detection

      - name: Install Gitleaks CLI (OSS)
        shell: bash
        run: |
          set -euo pipefail
          VERSION="8.18.4"
          URL="https://github.com/gitleaks/gitleaks/releases/download/v${VERSION}/gitleaks_${VERSION}_linux_x64.tar.gz"
          echo "Downloading gitleaks $VERSION from $URL"
          curl -sSL "$URL" -o /tmp/gitleaks.tgz
          tar -xzf /tmp/gitleaks.tgz -C /tmp
          sudo mv /tmp/gitleaks /usr/local/bin/gitleaks
          gitleaks version

      - name: Run Gitleaks Scan
        shell: bash
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          set -euo pipefail
          CONFIG_ARG=""
          if [ -f .gitleaks.toml ]; then CONFIG_ARG="--config .gitleaks.toml"; fi
          # Use redact to avoid leaking secrets in logs; fail on findings
          gitleaks detect --no-banner --redact $CONFIG_ARG --exit-code 1 --source .

  app-router-check: # T056 - Enforce App Router
    name: Lint - Enforce App Router (No Pages Dir)
    runs-on: ubuntu-latest
    timeout-minutes: 2
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Check for pages directory
        run: |
          if [ -d "frontend-next/src/pages" ] || [ -d "frontend-next/pages" ]; then
            echo "❌ Error: The 'pages' directory is present in 'frontend-next'."
            echo "This project must use the Next.js App Router ('app/' directory) exclusively."
            exit 1
          else
            echo "✅ Correct: No 'pages' directory found."
          fi
          if [ -d "frontend-next/src/pages/api" ] || [ -d "frontend-next/pages/api" ]; then
             echo "❌ Error: The 'pages/api' directory is present in 'frontend-next'."
             echo "API routes must use the App Router ('app/api/' directory)."
             exit 1
          else
              echo "✅ Correct: No 'pages/api' directory found."
          fi

  contracts-spectral:
    name: Contracts - Spectral Lint
    needs: [secret-scan, app-router-check]
    runs-on: ubuntu-latest
    timeout-minutes: 5
    concurrency:
      group: spectral-${{ github.ref }}
      cancel-in-progress: true
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Enable Corepack
        run: |
          corepack enable
          corepack prepare pnpm@9.x --activate

      - name: Setup Node 20
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'pnpm'

      - name: Install root dependencies (tsx/yaml for contracts checks)
        run: pnpm install --ignore-scripts --frozen-lockfile=false --silent

      - name: Spectral Lint (pinned CLI @6.11.0 - T054)
        env:
          SPECTRAL_REPORT: specs/008-identity-platform/contracts/spectral-report.json
        run: |
          set -euo pipefail
          mkdir -p "$(dirname "$SPECTRAL_REPORT")"
          node scripts/generate-spectral-report.mjs
          # Ensure report file exists and is non-empty
          if [ ! -s "$SPECTRAL_REPORT" ]; then
            echo "Spectral report was not created; failing step"
            exit 1
          fi

      - name: Check Spectral Errors
        run: |
          if [ -f specs/008-identity-platform/contracts/spectral-report.json ]; then
            # Ensure jq is installed
            sudo apt-get update && sudo apt-get install -y jq
            SPECTRAL_ERRORS=$(cat specs/008-identity-platform/contracts/spectral-report.json | jq '[.[] | select(.severity == 0)] | length')
            echo "Spectral errors found: $SPECTRAL_ERRORS"
            if [ "$SPECTRAL_ERRORS" -gt 0 ]; then
              echo "❌ Found $SPECTRAL_ERRORS Spectral error(s). Fix them before merging."
              jq '[.[] | select(.severity == 0)]' specs/008-identity-platform/contracts/spectral-report.json
              exit 1
            fi
            echo "✅ No Spectral errors found"
          else
            echo "❌ Spectral report not found"
            exit 1
          fi

      - name: Check OpenAPI Drift
        run: pnpm run contracts:check # requires tsx/yaml from root devDependencies

      # Removed redundant Secret Pattern Check step
      # - name: Secret Pattern Check
      #   run: pnpm run gate:secrets

      - name: Upload Spectral Report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: contracts-spectral-report
          path: specs/008-identity-platform/contracts/spectral-report.json
          retention-days: 21

      - name: Job Summary
        if: always()
        run: |
          {
            echo "### Spectral Lint - openapi.yaml"
            echo "Report: contracts-spectral-report/spectral-report.json"
            if [ -f specs/008-identity-platform/contracts/spectral-report.json ]; then
              echo ""
              echo "#### Report Contents (Errors Only):"
              jq '[.[] | select(.severity == 0)]' specs/008-identity-platform/contracts/spectral-report.json || echo "No errors found or report invalid."
            else
              echo "Spectral report file not found."
            fi
          } >> "$GITHUB_STEP_SUMMARY"

  dependency-audit:
    name: Security - Dependency Audit (non-gating) (T090)
    runs-on: ubuntu-latest
    timeout-minutes: 10
    continue-on-error: true
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      - name: Setup Node 20
        uses: actions/setup-node@v4
        with:
          node-version: '20'
      - name: Enable Corepack (pnpm)
        run: |
          corepack enable
          corepack prepare pnpm@9.x --activate
      - name: Install (frozen)
        run: pnpm install --ignore-scripts --frozen-lockfile=false
      - name: Audit for High/Critical
        run: |
          # Prefer npm audit (broad ecosystem support) for now
          npm audit --audit-level=high || true
      - name: Job Summary
        if: always()
        run: echo "Dependency audit executed (non-gating). See logs for findings." >> "$GITHUB_STEP_SUMMARY"
