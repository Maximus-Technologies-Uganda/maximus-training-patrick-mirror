name: CI

on:
  pull_request:
  push:
    branches:
      - main

concurrency:
  group: ci-${{ github.ref }}
  cancel-in-progress: true

jobs:
  test:
    strategy:
      fail-fast: false
      matrix:
        os: [ubuntu-latest, windows-latest]
        node-version: [18, 20, 22]
    runs-on: ${{ matrix.os }}
    timeout-minutes: 15
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node ${{ matrix.node-version }}
        uses: actions/setup-node@v4
        with:
          node-version: ${{ matrix.node-version }}
          cache: 'npm'

      - name: Install
        run: npm install --no-audit --no-fund
        shell: bash

      - name: Install expense dependencies
        run: cd expense && npm install
        shell: bash
        continue-on-error: true

      - name: Run expense tests with coverage
        run: cd expense && npm test -- --coverage --coverageReporters=lcov --coverageReporters=json-summary
        shell: bash
        continue-on-error: true

      - name: Install todo dependencies
        run: cd todo && npm install
        shell: bash
        continue-on-error: true

      - name: Run todo tests with coverage
        run: cd todo && npm test -- --coverage --coverageReporters=lcov --coverageReporters=json-summary
        shell: bash
        continue-on-error: true

      - name: Install stopwatch dependencies
        run: cd stopwatch && npm install
        shell: bash
        continue-on-error: true

      - name: Run stopwatch tests with coverage
        run: cd stopwatch && npm test -- --coverage --coverageReporters=lcov --coverageReporters=json-summary
        shell: bash
        continue-on-error: true

      - name: Install quote dependencies
        run: cd quote && npm install
        shell: bash
        continue-on-error: true

      - name: Run quote tests with coverage
        run: cd quote && npm test -- --coverage --coverageReporters=lcov --coverageReporters=json-summary
        shell: bash
        continue-on-error: true

      - name: Generate review.md
        shell: bash
        run: |
          echo "# CI Review Packet" > review.md
          echo "## Environment" >> review.md
          node -v >> review.md
          npm -v >> review.md
          echo "" >> review.md
          echo "## Test Results Summary" >> review.md
          echo "- Expense app: $([ -d "expense/coverage" ] && echo "coverage generated" || echo "no coverage")" >> review.md
          echo "- Todo app: $([ -d "todo/coverage" ] && echo "coverage generated" || echo "no coverage")" >> review.md
          echo "- Stopwatch app: $([ -d "stopwatch/coverage" ] && echo "coverage generated" || echo "no coverage")" >> review.md
          echo "- Quote app: $([ -d "quote/coverage" ] && echo "coverage generated" || echo "no coverage")" >> review.md
          echo "" >> review.md
          echo "## Commit Summary (last 10)" >> review.md
          git log -n 10 --pretty=format:'- %h %ad %an â€” %s' --date=short >> review.md || echo "Git log unavailable" >> review.md

      - name: Upload expense coverage artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: coverage-expense-${{ matrix.os }}-node${{ matrix.node-version }}
          path: |
            expense/coverage/coverage-summary.json
            expense/coverage/lcov-report/index.html

      - name: Upload todo coverage artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: coverage-todo-${{ matrix.os }}-node${{ matrix.node-version }}
          path: |
            todo/coverage/coverage-summary.json
            todo/coverage/lcov-report/index.html

      - name: Upload stopwatch coverage artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: coverage-stopwatch-${{ matrix.os }}-node${{ matrix.node-version }}
          path: |
            stopwatch/coverage/coverage-summary.json
            stopwatch/coverage/lcov-report/index.html

      - name: Upload quote coverage artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: coverage-quote-${{ matrix.os }}-node${{ matrix.node-version }}
          path: |
            quote/coverage/coverage-summary.json
            quote/coverage/lcov-report/index.html

  package-artifacts:
    needs: test
    if: always()
    runs-on: ubuntu-latest
    timeout-minutes: 5
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Download all coverage artifacts
        uses: actions/download-artifact@v4
        with:
          path: downloaded-artifacts
          merge-multiple: true

      - name: Organize artifacts
        run: |
          mkdir -p review-packet/coverage-reports
          # Copy coverage files for each app
          if [ -d "downloaded-artifacts" ]; then
            # Copy expense coverage
            if [ -f "downloaded-artifacts/coverage-summary.json" ] || [ -f "downloaded-artifacts/index.html" ]; then
              mkdir -p review-packet/coverage-reports/expense
              cp downloaded-artifacts/coverage-summary.json review-packet/coverage-reports/expense/ 2>/dev/null || true
              cp downloaded-artifacts/index.html review-packet/coverage-reports/expense/ 2>/dev/null || true
            fi
            # Copy coverage files from subdirectories
            find downloaded-artifacts -name "coverage-summary.json" -exec cp {} review-packet/coverage-reports/ \;
            find downloaded-artifacts -name "index.html" -exec cp {} review-packet/coverage-reports/ \;
          fi

          # Copy review.md
          cp review.md review-packet/ 2>/dev/null || echo "# Review Packet" > review-packet/review.md

      - name: Create review-packet.zip
        run: |
          cd review-packet
          zip -r ../review-packet.zip ./*
          cd ..
          ls -la review-packet.zip

      - name: Upload final review packet
        uses: actions/upload-artifact@v4
        with:
          name: review-packet
          path: review-packet.zip


