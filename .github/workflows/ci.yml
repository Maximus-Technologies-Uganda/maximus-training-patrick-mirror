name: CI

on:
  pull_request:
  push:
    branches:
      - main

concurrency:
  group: ci-${{ github.ref }}
  cancel-in-progress: true

jobs:
  test:
    strategy:
      fail-fast: false
      matrix:
        os: [ubuntu-latest, windows-latest]
        node-version: [18, 20, 22]
    runs-on: ${{ matrix.os }}
    timeout-minutes: 15
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node ${{ matrix.node-version }}
        uses: actions/setup-node@v4
        with:
          node-version: ${{ matrix.node-version }}
          cache: 'npm'

      - name: Install
        run: npm install --no-audit --no-fund
        shell: bash

      - name: Install expense dependencies
        run: cd expense && npm install
        shell: bash
        continue-on-error: true

      - name: Run expense tests with coverage
        run: cd expense && npm test -- --coverage --coverageReporters=lcov --coverageReporters=json-summary
        shell: bash
        continue-on-error: true

      - name: Install todo dependencies
        run: cd todo && npm install
        shell: bash
        continue-on-error: true

      - name: Run todo tests with coverage
        run: cd todo && npm test -- --coverage --coverageReporters=lcov --coverageReporters=json-summary
        shell: bash
        continue-on-error: true

      - name: Install stopwatch dependencies
        run: cd stopwatch && npm install
        shell: bash
        continue-on-error: true

      - name: Run stopwatch tests with coverage
        run: cd stopwatch && npm test -- --coverage --coverageReporters=lcov --coverageReporters=json-summary
        shell: bash
        continue-on-error: true

      - name: Install quote dependencies
        run: cd quote && npm install
        shell: bash
        continue-on-error: true

      - name: Run quote tests with coverage
        run: cd quote && npm test -- --coverage --coverageReporters=lcov --coverageReporters=json-summary
        shell: bash
        continue-on-error: true

      - name: Generate review.md
        shell: bash
        run: |
          echo "# CI Review Packet" > review.md
          echo "## Environment" >> review.md
          node -v >> review.md
          npm -v >> review.md
          echo "" >> review.md
          echo "## Test Results Summary" >> review.md
          echo "- Expense app: $([ -d "expense/coverage" ] && echo "coverage generated" || echo "no coverage")" >> review.md
          echo "- Todo app: $([ -d "todo/coverage" ] && echo "coverage generated" || echo "no coverage")" >> review.md
          echo "- Stopwatch app: $([ -d "stopwatch/coverage" ] && echo "coverage generated" || echo "no coverage")" >> review.md
          echo "- Quote app: $([ -d "quote/coverage" ] && echo "coverage generated" || echo "no coverage")" >> review.md
          echo "" >> review.md
          echo "## Commit Summary (last 10)" >> review.md
          git log -n 10 --pretty=format:'- %h %ad %an — %s' --date=short >> review.md || echo "Git log unavailable" >> review.md

      - name: Upload expense coverage artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: coverage-expense-${{ matrix.os }}-node${{ matrix.node-version }}
          path: |
            expense/coverage/coverage-final.json
            expense/coverage/lcov-report/index.html

      - name: Upload todo coverage artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: coverage-todo-${{ matrix.os }}-node${{ matrix.node-version }}
          path: |
            todo/coverage/coverage-final.json
            todo/coverage/lcov-report/index.html

      - name: Upload stopwatch coverage artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: coverage-stopwatch-${{ matrix.os }}-node${{ matrix.node-version }}
          path: |
            stopwatch/coverage/coverage-final.json
            stopwatch/coverage/lcov-report/index.html

      - name: Upload quote coverage artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: coverage-quote-${{ matrix.os }}-node${{ matrix.node-version }}
          path: |
            quote/coverage/coverage-final.json
            quote/coverage/lcov-report/index.html

      - name: Upload review.md
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: review-md-${{ matrix.os }}-node${{ matrix.node-version }}
          path: review.md

  package-artifacts:
    needs: test
    if: always()
    runs-on: ubuntu-latest
    timeout-minutes: 5
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Download all coverage artifacts
        uses: actions/download-artifact@v4
        with:
          path: downloaded-artifacts
          merge-multiple: true

      - name: Download review.md
        uses: actions/download-artifact@v4
        with:
          name: review-md-ubuntu-latest-node20
          path: downloaded-artifacts

      - name: Organize artifacts
        run: |
          mkdir -p review-packet/coverage-reports/{expense,todo,stopwatch,quote}

          # Debug: List all downloaded artifacts
          echo "=== Downloaded Artifacts Structure ==="
          find downloaded-artifacts -type f | sort

          echo ""
          echo "=== Collecting Coverage Files ==="

          # Collect coverage files for each app using a more robust approach
          for app in expense todo stopwatch quote; do
            echo "Processing $app coverage files..."

            # Find and copy coverage-final.json
            coverage_files=$(find downloaded-artifacts -name "*$app*" -name "coverage-final.json" 2>/dev/null)
            if [ -n "$coverage_files" ]; then
              echo "Found coverage-final.json for $app:"
              echo "$coverage_files" | head -1
              cp "$(echo "$coverage_files" | head -1)" "review-packet/coverage-reports/$app/" 2>/dev/null || true
              echo "✓ Copied coverage-final.json for $app"
            else
              echo "✗ No coverage-final.json found for $app"
            fi

            # Find and copy index.html (lcov report)
            html_files=$(find downloaded-artifacts -name "*$app*" -name "index.html" 2>/dev/null)
            if [ -n "$html_files" ]; then
              echo "Found index.html for $app:"
              echo "$html_files" | head -1
              cp "$(echo "$html_files" | head -1)" "review-packet/coverage-reports/$app/" 2>/dev/null || true
              echo "✓ Copied index.html for $app"
            else
              echo "✗ No index.html found for $app"
            fi
          done

          echo ""
          echo "=== Coverage Collection Summary ==="
          for app in expense todo stopwatch quote; do
            coverage_file="review-packet/coverage-reports/$app/coverage-final.json"
            html_file="review-packet/coverage-reports/$app/index.html"

            if [ -f "$coverage_file" ] && [ -f "$html_file" ]; then
              echo "✓ $app: Both coverage files collected successfully"
            elif [ -f "$coverage_file" ]; then
              echo "⚠ $app: Only coverage-final.json found (missing index.html)"
            elif [ -f "$html_file" ]; then
              echo "⚠ $app: Only index.html found (missing coverage-final.json)"
            else
              echo "✗ $app: No coverage files found"
            fi
          done

          echo ""
          echo "=== Final Review Packet Structure ==="
          find review-packet -type f | sort

          # Copy review.md
          if [ -f "downloaded-artifacts/review.md" ]; then
            cp downloaded-artifacts/review.md review-packet/ 2>/dev/null || true
            echo "✓ Copied existing review.md"
          else
            echo "# CI Review Packet" > review-packet/review.md
            echo "## Generated on $(date)" >> review-packet/review.md
            echo "" >> review-packet/review.md
            echo "## Coverage Reports Summary" >> review-packet/review.md
            echo "- Expense app: $([ -f "review-packet/coverage-reports/expense/coverage-final.json" ] && echo "✓ Available" || echo "✗ Missing")" >> review-packet/review.md
            echo "- Todo app: $([ -f "review-packet/coverage-reports/todo/coverage-final.json" ] && echo "✓ Available" || echo "✗ Missing")" >> review-packet/review.md
            echo "- Stopwatch app: $([ -f "review-packet/coverage-reports/stopwatch/coverage-final.json" ] && echo "✓ Available" || echo "✗ Missing")" >> review-packet/review.md
            echo "- Quote app: $([ -f "review-packet/coverage-reports/quote/coverage-final.json" ] && echo "✓ Available" || echo "✗ Missing")" >> review-packet/review.md
            echo "" >> review-packet/review.md
            echo "## Environment Details" >> review-packet/review.md
            echo "- CI Run: ${{ github.run_id }}" >> review-packet/review.md
            echo "- Branch: ${{ github.ref_name }}" >> review-packet/review.md
            echo "" >> review-packet/review.md
            echo "## Note" >> review-packet/review.md
            echo "This review packet contains coverage reports from all four applications." >> review-packet/review.md
          fi

      - name: Create review-packet.zip
        run: |
          cd review-packet
          zip -r ../review-packet.zip ./*
          cd ..
          ls -la review-packet.zip

      - name: Upload final review packet
        uses: actions/upload-artifact@v4
        with:
          name: review-packet
          path: review-packet.zip


