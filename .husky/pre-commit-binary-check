#!/usr/bin/env sh
set -e

echo "üö´ Checking for large files and binaries..."

# Reject files > 50MB
MAX_SIZE=$((50 * 1024 * 1024))
LARGE_FILES=$(git diff --cached --name-only --diff-filter=A,M | while read file; do
  if [ -z "$file" ]; then
    continue
  fi
  # Try to get file size from git, then fall back to filesystem
  size=$(git cat-file -s ":0:$file" 2>/dev/null || stat -f "%z" "$file" 2>/dev/null || wc -c < "$file" 2>/dev/null || echo 0)
  if [ "$size" -gt "$MAX_SIZE" ]; then
    echo "$file ($((size / 1024 / 1024))MB)"
  fi
done)

if [ -n "$LARGE_FILES" ]; then
  echo "‚ùå Large files detected (> 50MB). Add to .gitignore:"
  echo "$LARGE_FILES"
  exit 1
fi

echo "‚úÖ No large binaries detected"

# Detect potential credentials (warning only)
CREDS_PATTERN=$(git diff --cached | grep -iE '(password|token|api[_-]?key|secret|credential)' 2>/dev/null || true)
if [ -n "$CREDS_PATTERN" ]; then
  echo "‚ö†Ô∏è  Possible credentials detected in diff. Review before committing:"
  echo "$CREDS_PATTERN" | head -5
  echo ""
  echo "If this is a false positive, you can bypass with: git commit --no-verify"
fi
